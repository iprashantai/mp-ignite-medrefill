<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Data Flow Diagram</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Data Flow Diagram</h1>
</header>
<h1 id="data-flow-diagram-medication-adherence-refill-worklist">Data
Flow Diagram: Medication Adherence Refill Worklist</h1>
<p><strong>Purpose:</strong> Visual representation of data movement
through the system.</p>
<hr />
<h2 id="high-level-system-architecture">High-Level System
Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                           EXTERNAL DATA SOURCES                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│   │   PBM/Claims │    │     EMR      │    │   Pharmacy   │                  │
│   │   (RxClaims) │    │  (Patients)  │    │   (Rx Data)  │                  │
│   └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                  │
│          │                   │                   │                           │
└──────────┼───────────────────┼───────────────────┼───────────────────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FIREBASE FIRESTORE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │                        COLLECTIONS                                │      │
│   ├──────────────────────────────────────────────────────────────────┤      │
│   │                                                                   │      │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐      │      │
│   │   │ allPatients │  │  rxClaims   │  │ medAdherenceDrugs   │      │      │
│   │   │             │  │             │  │   (MAC/MAD/MAH)     │      │      │
│   │   │ - Member_Id │  │ - Member_Id │  │                     │      │      │
│   │   │ - fullName  │  │ - Drug_Name │  │ - drugName          │      │      │
│   │   │ - DOB       │  │ - NDC       │  │ - measureType       │      │      │
│   │   │ - meds[]    │  │ - fill_date │  │ - NDC codes         │      │      │
│   │   │             │  │ - days_supply│ │                     │      │      │
│   │   └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘      │      │
│   │          │                │                    │                  │      │
│   └──────────┼────────────────┼────────────────────┼──────────────────┘      │
│              │                │                    │                         │
└──────────────┼────────────────┼────────────────────┼─────────────────────────┘
               │                │                    │
               ▼                ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CALCULATION ENGINE                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                   fragilityTierService.js                           │    │
│   ├────────────────────────────────────────────────────────────────────┤    │
│   │                                                                     │    │
│   │   INPUT:                           OUTPUT:                          │    │
│   │   - rxClaims (fill history)        - PDC (current %)                │    │
│   │   - First fill date                - Gap Days Used                  │    │
│   │   - Today&#39;s date                   - Gap Days Remaining             │    │
│   │   - Dec 31 (year end)              - Delay Budget                   │    │
│   │                                    - Fragility Tier (F1-F5/T5)      │    │
│   │   FORMULAS:                        - Priority Score                 │    │
│   │   Treatment Period = FirstFill → Dec 31                             │    │
│   │   Covered Days = sum(days_supply)                                   │    │
│   │   PDC = Covered / Treatment × 100                                   │    │
│   │   Gap Days Allowed = Treatment × 20%                                │    │
│   │   Gap Days Remaining = Allowed - Used                               │    │
│   │   Delay Budget = GapRemaining / RefillsNeeded                       │    │
│   │                                                                     │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────┬──────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PRIORITIZATION ENGINE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                   Priority Score Calculation                        │    │
│   ├────────────────────────────────────────────────────────────────────┤    │
│   │                                                                     │    │
│   │   BASE SCORE (by tier):          BONUS POINTS:                      │    │
│   │   ├── F1 Critical: 100 pts       ├── Out of Meds: +30 pts           │    │
│   │   ├── F2 Fragile:   80 pts       ├── Q4 (Oct-Dec): +25 pts          │    │
│   │   ├── F3 Moderate:  60 pts       ├── Multiple MA: +15 pts           │    │
│   │   ├── F4 Stable:    40 pts       └── New Patient: +10 pts           │    │
│   │   └── F5 Safe:      20 pts                                          │    │
│   │                                                                     │    │
│   │   URGENCY INDEX:                                                    │    │
│   │   ├── Extreme: 150+ pts                                             │    │
│   │   ├── High: 100-149 pts                                             │    │
│   │   ├── Moderate: 50-99 pts                                           │    │
│   │   └── Low: &lt;50 pts                                                  │    │
│   │                                                                     │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────┬──────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           UI COMPONENTS                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│   │ RefillWorklist  │    │  AllPatientsCRM │    │ MetricsReference│         │
│   │     Page.jsx    │    │      .jsx       │    │     .jsx        │         │
│   ├─────────────────┤    ├─────────────────┤    ├─────────────────┤         │
│   │ - Priority queue│    │ - Full patient  │    │ - Golden        │         │
│   │ - Tier badges   │    │   list          │    │   Standard      │         │
│   │ - PDC status    │    │ - Search/filter │    │ - All formulas  │         │
│   │ - Actions       │    │ - Bulk actions  │    │ - Tier defs     │         │
│   └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="detailed-data-flow-patient-to-worklist">Detailed Data Flow:
Patient to Worklist</h2>
<pre><code>Step 1: LOAD PATIENT DATA
━━━━━━━━━━━━━━━━━━━━━━━━━

    allPatients Collection
    ┌────────────────────────────────────────┐
    │ {                                       │
    │   id: &quot;DEMO_001&quot;,                       │
    │   fullName: &quot;Maria Gonzalez&quot;,           │
    │   Member_Id: &quot;DEMO_001&quot;,                │
    │   dateOfBirth: &quot;1955-03-15&quot;,            │
    │   medications: [                        │
    │     { name: &quot;Lisinopril 10mg&quot;, ... }    │
    │   ]                                     │
    │ }                                       │
    └────────────────────────────────────────┘
                      │
                      ▼
Step 2: FETCH RX CLAIMS
━━━━━━━━━━━━━━━━━━━━━━━

    rxClaims Collection (filtered by Member_Id)
    ┌────────────────────────────────────────┐
    │ [                                       │
    │   {                                     │
    │     Member_Id: &quot;DEMO_001&quot;,              │
    │     Drug_Name: &quot;LISINOPRIL 10MG&quot;,       │
    │     Rx_Date_Of_Service: &quot;2025-01-15&quot;,   │
    │     days_supply: 30,                    │
    │     NDC: &quot;00378-0243-01&quot;                │
    │   },                                    │
    │   {                                     │
    │     Member_Id: &quot;DEMO_001&quot;,              │
    │     Drug_Name: &quot;LISINOPRIL 10MG&quot;,       │
    │     Rx_Date_Of_Service: &quot;2025-02-14&quot;,   │
    │     days_supply: 30,                    │
    │     NDC: &quot;00378-0243-01&quot;                │
    │   },                                    │
    │   ... (more fills)                      │
    │ ]                                       │
    └────────────────────────────────────────┘
                      │
                      ▼
Step 3: MATCH TO MA MEASURE
━━━━━━━━━━━━━━━━━━━━━━━━━━━

    medAdherenceDrugs Collection
    ┌────────────────────────────────────────┐
    │ {                                       │
    │   drugName: &quot;LISINOPRIL&quot;,               │
    │   measureType: &quot;MAH&quot;,                   │
    │   drugClass: &quot;ACE Inhibitors&quot;           │
    │ }                                       │
    └────────────────────────────────────────┘

    Result: Lisinopril → MAH (Hypertension)
                      │
                      ▼
Step 4: CALCULATE PDC &amp; FRAGILITY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    fragilityTierService.calculateMetrics()

    INPUT:
    ┌────────────────────────────────────────┐
    │ fills: [Jan 15, Feb 14, Mar 16, ...]   │
    │ today: Nov 15, 2025                    │
    │ yearEnd: Dec 31, 2025                  │
    └────────────────────────────────────────┘

    CALCULATIONS:
    ┌────────────────────────────────────────┐
    │ firstFillDate = Jan 15                  │
    │ treatmentPeriod = 351 days              │
    │ coveredDays = 253 days                  │
    │ gapDaysUsed = 98 days                   │
    │ gapDaysAllowed = 70 days                │
    │ gapDaysRemaining = -28 days             │
    │ PDC = 72.1%                             │
    └────────────────────────────────────────┘

    OUTPUT:
    ┌────────────────────────────────────────┐
    │ {                                       │
    │   pdc: 72.1,                            │
    │   pdcStatus: &quot;CAUTION&quot;,                 │
    │   gapDaysRemaining: -28,                │
    │   fragilityTier: &quot;T5&quot;,                  │
    │   tierLabel: &quot;Lost&quot;,                    │
    │   isSalvageable: false                  │
    │ }                                       │
    └────────────────────────────────────────┘
                      │
                      ▼
Step 5: CALCULATE PRIORITY SCORE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    For salvageable patients (not T5):

    ┌────────────────────────────────────────┐
    │ baseScore = 80 (F2 Fragile)             │
    │ + outOfMeds = 30                        │
    │ + isQ4 = 25                             │
    │ ─────────────────                       │
    │ totalScore = 135 → HIGH priority        │
    └────────────────────────────────────────┘
                      │
                      ▼
Step 6: DETERMINE PATHWAY
━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌────────────────────────────────────────┐
    │ Has Refills? YES                        │
    │ Rx Expired? NO                          │
    │ ─────────────────                       │
    │ Pathway = REFILL                        │
    └────────────────────────────────────────┘
                      │
                      ▼
Step 7: DISPLAY IN WORKLIST
━━━━━━━━━━━━━━━━━━━━━━━━━━━

    RefillWorklistPage.jsx
    ┌────────────────────────────────────────────────────────────────┐
    │ ┌────────────────────────────────────────────────────────────┐ │
    │ │ HIGH PRIORITY QUEUE                                         │ │
    │ ├────────────────────────────────────────────────────────────┤ │
    │ │ Name           │ PDC  │ Tier │ Days Left │ Action           │ │
    │ │────────────────┼──────┼──────┼───────────┼─────────────────│ │
    │ │ Maria Gonzalez │ 72%  │ F2   │ OUT       │ [Call] [Refill]  │ │
    │ │ Robert Chen    │ 68%  │ F1   │ 5 days    │ [Call] [Refill]  │ │
    │ └────────────────────────────────────────────────────────────┘ │
    └────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="refill-vs-renewal-decision-flow">Refill vs Renewal Decision
Flow</h2>
<pre><code>                    ┌─────────────────────────────┐
                    │   PATIENT NEEDS MEDICATION  │
                    └─────────────┬───────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │    Has Refills Remaining?   │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                   YES                         NO
                    │                           │
                    ▼                           ▼
        ┌───────────────────┐       ┌───────────────────┐
        │   Rx Expired?     │       │ Recent Visit      │
        │                   │       │ (≤90 days)?       │
        └─────────┬─────────┘       └─────────┬─────────┘
                  │                           │
        ┌─────────┴─────────┐       ┌─────────┴─────────┐
        │                   │       │                   │
       NO                  YES     YES                 NO
        │                   │       │                   │
        ▼                   ▼       ▼                   ▼
   ┌─────────┐        ┌─────────┐ ┌─────────┐     ┌─────────────┐
   │ REFILL  │        │ RENEWAL │ │ RENEWAL │     │ APPOINTMENT │
   │         │        │         │ │         │     │   NEEDED    │
   │ FR-3.1.1│        │ FR-3.1.2│ │ FR-3.1.3│     │   FR-3.1.4  │
   └─────────┘        └─────────┘ └─────────┘     └─────────────┘</code></pre>
<hr />
<h2 id="data-dependencies">Data Dependencies</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                     DATA DEPENDENCY GRAPH                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   allPatients ─────┬──────────────────────────────────────────► │
│        │           │                                             │
│        │           │ JOIN on Member_Id                           │
│        │           │                                             │
│   rxClaims ────────┼──────────────────────────────────────────► │
│        │           │                                             │
│        │           ▼                                             │
│        │   ┌───────────────┐                                     │
│        │   │ PDC Calculation│                                    │
│        │   └───────┬───────┘                                     │
│        │           │                                             │
│        │           ▼                                             │
│        │   ┌───────────────┐                                     │
│        │   │ Fragility Tier │                                    │
│        │   └───────┬───────┘                                     │
│        │           │                                             │
│        │           ▼                                             │
│        │   ┌───────────────┐                                     │
│        └──►│Priority Score │                                     │
│            └───────┬───────┘                                     │
│                    │                                             │
│                    ▼                                             │
│            ┌───────────────┐                                     │
│            │   Worklist    │                                     │
│            │   Display     │                                     │
│            └───────────────┘                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="key-files-by-data-layer">Key Files by Data Layer</h2>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 20%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr>
<th>Layer</th>
<th>File</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Data Source</strong></td>
<td><code>rxClaimsService.js</code></td>
<td>Fetch claims from Firestore</td>
</tr>
<tr>
<td><strong>Calculation</strong></td>
<td><code>fragilityTierService.js</code></td>
<td>PDC, gap days, tier calculation</td>
</tr>
<tr>
<td><strong>Calculation</strong></td>
<td><code>medAdherenceService.js</code></td>
<td>PDC calculations, status</td>
</tr>
<tr>
<td><strong>Business Logic</strong></td>
<td><code>src/pages/MetricsReference.jsx</code></td>
<td>Golden Standard (authoritative)</td>
</tr>
<tr>
<td><strong>UI</strong></td>
<td><code>RefillWorklistPage.jsx</code></td>
<td>Worklist display</td>
</tr>
<tr>
<td><strong>UI</strong></td>
<td><code>AllPatientsCRM.jsx</code></td>
<td>Patient list</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Document generated for tech handoff - January 3, 2026</em></p>
</body>
</html>
